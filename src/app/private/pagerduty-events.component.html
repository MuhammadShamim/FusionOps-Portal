<fusionops-private-layout [isAuthenticated]="authService.isAuthenticated">
  <div class="container-fluid px-0">
    <h2 class="mb-4">PagerDuty Events</h2>
    <div *ngIf="loading" class="alert alert-info">Loading PagerDuty events...</div>
    <div *ngIf="error" class="alert alert-danger">{{error}}</div>
    <div class="row mb-3" *ngIf="!loading && !error">
      <div class="col-md-4 mb-2">
        <input type="text" class="form-control" placeholder="Search events..." [(ngModel)]="search" (ngModelChange)="onSearchChange()">
      </div>
      <div class="col-md-4 mb-2">
        <div class="dropdown">
          <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown">
            Columns
          </button>
          <ul class="dropdown-menu">
            <li *ngFor="let col of columns">
              <label class="dropdown-item">
                <input type="checkbox" [(ngModel)]="col.visible" (change)="toggleColumn(col)"> {{col.label}}
              </label>
            </li>
          </ul>
        </div>
      </div>
      <div class="col-md-4 text-end mb-2">
        <button class="btn btn-outline-primary me-2" (click)="downloadCSV(selectedRows.size > 0)"><i class="fas fa-download me-2"></i>Download as CSV</button>
        <button class="btn btn-outline-secondary me-2" [disabled]="selectedRows.size === 0" (click)="copySelectedToClipboard()"><i class="fas fa-copy me-2"></i>Copy Selected</button>
        <button class="btn btn-outline-secondary" [disabled]="selectedRows.size === 0" (click)="clearSelection()"><i class="fas fa-times me-2"></i>Clear Selection</button>
      </div>
    </div>
    <div *ngIf="!loading && !error && filteredEvents.length === 0" class="alert alert-warning">No PagerDuty events found.</div>
    <div *ngIf="filteredEvents.length > 0" class="table-responsive mt-3">
      <table class="table table-hover table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>
              <input type="checkbox" [checked]="areAllRowsSelectedOnPage()" (change)="$event.target.checked ? selectAllOnPage() : clearSelection()">
            </th>
            <ng-container *ngFor="let col of columns" >
              <th *ngIf="col.visible" (click)="sortBy(col.key, $event)" style="cursor:pointer">
                {{col.label}} <i class="fas fa-sort"></i>
              </th>
            </ng-container>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let event of pagedEvents">
            <td>
              <input type="checkbox" [checked]="selectedRows.has(event.id)" (change)="toggleRowSelection(event.id)">
            </td>
            <ng-container *ngFor="let col of columns">
              <td *ngIf="col.visible">
                <ng-container [ngSwitch]="col.key">
                  <span *ngSwitchCase="'service'">{{event.service?.summary}}</span>
                  <span *ngSwitchCase="'created_at'">{{event.created_at | date:'short'}}</span>
                  <span *ngSwitchDefault>{{event[col.key]}}</span>
                </ng-container>
              </td>
            </ng-container>
          </tr>
        </tbody>
      </table>
      <nav *ngIf="totalPages > 1" class="mt-3">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="page === 1">
            <a class="page-link" href="#" (click)="$event.preventDefault(); setPage(page-1)">&laquo;</a>
          </li>
          <li class="page-item" *ngFor="let p of [].constructor(totalPages); let i = index" [class.active]="page === (i+1)">
            <a class="page-link" href="#" (click)="$event.preventDefault(); setPage(i+1)">{{i+1}}</a>
          </li>
          <li class="page-item" [class.disabled]="page === totalPages">
            <a class="page-link" href="#" (click)="$event.preventDefault(); setPage(page+1)">&raquo;</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</fusionops-private-layout>
